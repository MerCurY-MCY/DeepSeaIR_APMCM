import torch.nn as nn
import torch
'''
æ®‹å·®å—çš„æ ¸å¿ƒæ€æƒ³æ˜¯è·³è·ƒè¿æ¥ï¼Œæ˜¯è®©ç½‘ç»œä¸­çš„æŸäº›å±‚çš„è¾“å…¥ç›´æ¥è·³è·ƒåˆ°åé¢çš„æŸäº›å±‚ï¼Œè€Œä¸ç»è¿‡ä¸­é—´çš„å·ç§¯ã€æ¿€æ´»ç­‰æ“ä½œã€‚
ä¼ ç»Ÿçš„å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰é€šå¸¸æ˜¯å°†æ¯ä¸€å±‚çš„è¾“å…¥é€šè¿‡ä¸€ç³»åˆ—å·ç§¯å±‚ã€æ¿€æ´»å‡½æ•°ç­‰å¤„ç†ï¼Œæœ€ç»ˆå¾—åˆ°è¾“å‡ºã€‚
ä½†éšç€ç½‘ç»œæ·±åº¦å¢åŠ ï¼Œå®¹æ˜“å‘ç”Ÿ æ¢¯åº¦æ¶ˆå¤± æˆ– æ¢¯åº¦çˆ†ç‚¸ï¼Œä½¿å¾—è®­ç»ƒå˜å¾—éå¸¸å›°éš¾ã€‚
æ®‹å·®å—çš„å‡ºç°ï¼Œé€šè¿‡ç›´æ¥å°†è¾“å…¥ä¼ é€’åˆ°åé¢çš„å±‚ï¼Œä»è€Œä½¿å¾—è®­ç»ƒè¿‡ç¨‹å˜å¾—æ›´ç¨³å®šã€‚
ç®€è€Œè¨€ä¹‹ï¼Œæ®‹å·®å—ä¸ä»…å­¦ä¹ è¾“å…¥åˆ°è¾“å‡ºçš„ç›´æ¥æ˜ å°„ï¼Œè¿˜å­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„æ®‹å·®ï¼ˆresidualï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸¤è€…çš„å·®å€¼ã€‚

å‡è®¾ 
ğ‘¥æ˜¯è¾“å…¥ï¼Œç»è¿‡è‹¥å¹²å±‚çš„å·ç§¯æ“ä½œä¹‹åå¾—åˆ°çš„è¾“å‡ºæ˜¯ ğ¹(ğ‘¥)
ä¼ ç»Ÿç½‘ç»œä¼šç›´æ¥å°† xæ˜ å°„åˆ°è¾“å‡º ğ¹(ğ‘¥)ï¼Œè€Œåœ¨æ®‹å·®ç½‘ç»œä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ çš„æ˜¯æ®‹å·®
ï¼ˆå³ ğ¹(ğ‘¥)å’Œ ğ‘¥ä¹‹é—´çš„å·®å€¼ï¼‰ï¼Œç„¶åå†åŠ ä¸Šè¾“å…¥ ğ‘¥ï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºï¼š
Output=ğ¹(ğ‘¥) + ğ‘¥
è¿™é‡Œçš„ ğ¹(ğ‘¥)æ˜¯é€šè¿‡å·ç§¯å±‚å­¦ä¹ åˆ°çš„æ˜ å°„ï¼Œè€Œ ğ‘¥æ˜¯è¾“å…¥æ•°æ®ï¼ŒOutputå°±æ˜¯æ®‹å·®å—çš„è¾“å‡ºã€‚

ä¸ºä»€ä¹ˆæ®‹å·®å—æœ‰æ•ˆï¼Ÿ
1) ç¼“è§£æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼š
ä¼ ç»Ÿçš„æ·±åº¦ç½‘ç»œåœ¨å±‚æ•°å¢åŠ æ—¶ï¼Œè®­ç»ƒä¸­å¯èƒ½å‡ºç° æ¢¯åº¦æ¶ˆå¤±ï¼ˆvanishing gradientï¼‰ é—®é¢˜ï¼Œå³è¯¯å·®åœ¨åå‘ä¼ æ’­æ—¶ä¼šå˜å¾—éå¸¸å°ï¼Œå¯¼è‡´æ›´æ–°æ— æ³•æœ‰æ•ˆè¿›è¡Œã€‚æ®‹å·®å—é€šè¿‡ç›´æ¥ä¼ é€’è¾“å…¥ï¼Œä½¿å¾—æ¢¯åº¦å¯ä»¥ç›´æ¥ä¼ é€’åˆ°æ›´æ·±å±‚æ¬¡ï¼Œä»è€Œé¿å…äº†æ¢¯åº¦æ¶ˆå¤±çš„é—®é¢˜ã€‚
2) æ›´å®¹æ˜“ä¼˜åŒ–ï¼š
å¯¹äºæ·±å±‚ç½‘ç»œï¼Œæ®‹å·®å—è®©ç½‘ç»œå­¦ä¹ çš„ä»»åŠ¡å˜å¾—æ›´åŠ å®¹æ˜“â€”â€”å®ƒå­¦ä¹ çš„æ˜¯è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„ æ®‹å·®ï¼Œè€Œä¸æ˜¯ç›´æ¥å­¦ä¹ æ˜ å°„ã€‚è¿™ä½¿å¾—ä¼˜åŒ–æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºå­¦ä¹ æ®‹å·®æ¯”å­¦ä¹ ç›´æ¥æ˜ å°„è¦ç®€å•ã€‚
æ¢å¥è¯è¯´ï¼Œç½‘ç»œåªéœ€è¦å­¦ä¹ å¦‚ä½•æ”¹å˜è¾“å…¥ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹å­¦ä¼šæ˜ å°„æ‰€æœ‰ç‰¹å¾ã€‚
3) æ›´é«˜æ•ˆçš„è®­ç»ƒï¼š
åœ¨æ²¡æœ‰æ®‹å·®å—æ—¶ï¼Œæ·±åº¦ç½‘ç»œå¾€å¾€ä¼šé™·å…¥å±€éƒ¨æœ€å°å€¼ï¼Œå¯¼è‡´è®­ç»ƒå›°éš¾ã€‚è€Œå¼•å…¥æ®‹å·®å—åï¼Œç½‘ç»œå­¦ä¹ çš„ç›®æ ‡å˜å¾—æ›´åŠ æ˜ç¡®ï¼Œä»è€Œå¯ä»¥è·å¾—æ›´å¥½çš„è®­ç»ƒæ•ˆæœã€‚
4) åŠ é€Ÿæ”¶æ•›ï¼š
æ®‹å·®è¿æ¥ä½¿å¾—åå‘ä¼ æ’­çš„æ¢¯åº¦ä¿¡å·èƒ½å¤Ÿæ›´å®¹æ˜“åœ°é€šè¿‡è¾ƒæ·±çš„å±‚ä¼ æ’­ï¼Œè¿™æœ‰åŠ©äºåŠ é€Ÿè®­ç»ƒæ”¶æ•›ï¼Œå°¤å…¶æ˜¯åœ¨æ·±åº¦ç½‘ç»œä¸­ã€‚

åœ¨æ®‹å·®ç½‘ç»œä¸­ä¸­é—´å±‚çš„åœ°ä½ï¼š
åœ¨ä¼ ç»Ÿçš„ç½‘ç»œä¸­ï¼Œæ•°æ®ä»è¾“å…¥é€šè¿‡æ¯ä¸€å±‚çš„æ“ä½œï¼ˆå¦‚å·ç§¯ã€æ± åŒ–ç­‰ï¼‰é€æ­¥ä¼ é€’ï¼Œç›´åˆ°æœ€åä¸€å±‚å¾—åˆ°è¾“å‡ºã€‚ä½†æ˜¯ï¼Œè¿™æ ·çš„ç»“æ„åœ¨æ·±å±‚ç½‘ç»œä¸­å®¹æ˜“å¯¼è‡´ æ¢¯åº¦æ¶ˆå¤± æˆ– æ¢¯åº¦çˆ†ç‚¸ï¼Œè®­ç»ƒå˜å¾—å›°éš¾ï¼Œç”šè‡³åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæ·±å±‚ç½‘ç»œçš„æ€§èƒ½è¿˜ä¸å¦‚æµ…å±‚ç½‘ç»œã€‚
ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼ŒResNet ä¸­å¼•å…¥äº† è·³è·ƒè¿æ¥ï¼Œä½¿å¾—è¾“å…¥ ğ‘¥å¯ä»¥ç»•è¿‡ä¸­é—´çš„å·ç§¯å±‚ï¼Œç›´æ¥ä¸æœ€ç»ˆè¾“å‡ºç›¸åŠ ã€‚è¿™ç§ç»“æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯å­¦ä¹ æ®‹å·®ï¼Œè€Œä¸æ˜¯ç›´æ¥å­¦ä¹ è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„ã€‚
åœ¨å¼•å…¥è·³è·ƒè¿æ¥æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥è·³è¿‡ä¸­é—´å±‚ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥ä¿ç•™ä¸­é—´å±‚çš„ä½œç”¨ï¼š
1.æ¯ä¸€ä¸ªæ®‹å·®å—å†…éƒ¨çš„å±‚ï¼ˆå¦‚å·ç§¯å±‚ã€æ¿€æ´»å‡½æ•°ã€æ‰¹å½’ä¸€åŒ–ç­‰ï¼‰ä¾ç„¶èµ·åˆ°é‡è¦çš„ä½œç”¨ã€‚
å®ƒä»¬è´Ÿè´£æå–å’Œè½¬æ¢è¾“å…¥ç‰¹å¾ï¼Œåªæ˜¯ç½‘ç»œçš„ã€å­¦ä¹ ç›®æ ‡ã€‘è½¬å˜ä¸ºå­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„å·®å¼‚ï¼Œè€Œä¸æ˜¯å­¦ä¹ ä»è¾“å…¥åˆ°è¾“å‡ºçš„å®Œæ•´æ˜ å°„ã€‚
2.è·³è·ƒè¿æ¥åªæ˜¯åŠ å’Œæ“ä½œï¼Œå°†ä¸­é—´å±‚çš„è¾“å‡ºä¸è¾“å…¥ç›´æ¥ç›¸åŠ ã€‚å› æ­¤ï¼Œå°½ç®¡è¾“å…¥é€šè¿‡ä¸­é—´çš„å±‚è¿›è¡Œå¤„ç†ï¼Œä½†è¿™äº›å±‚çš„è¾“å‡ºä¸è¾“å…¥ä¹‹é—´çš„æ®‹å·®ç›¸åŠ ï¼Œæœ‰åŠ©äºé¿å…æ¢¯åº¦æ¶ˆå¤±ï¼Œä¸”ç½‘ç»œèƒ½å¤Ÿæ›´å®¹æ˜“åœ°è°ƒæ•´è¿™äº›ä¸­é—´å±‚çš„æƒé‡ã€‚
3.å®é™…ä¸Šï¼Œä¸­é—´å±‚çš„æ“ä½œä¾ç„¶éå¸¸é‡è¦ï¼Œè·³è·ƒè¿æ¥åªæ˜¯åœ¨è¾“å‡ºä¸­åŠ å…¥äº†åŸå§‹è¾“å…¥çš„ä¿¡æ¯ï¼Œä»¥å¸®åŠ©ç½‘ç»œæ›´æœ‰æ•ˆåœ°è®­ç»ƒã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç½‘ç»œåœ¨å­¦ä¹ è¿‡ç¨‹ä¸­èƒ½å¤Ÿ ç›´æ¥ä¼ é€’ä¿¡æ¯ï¼Œå¹¶ä¸”è°ƒæ•´ç‰¹å¾æå–çš„æ–¹å¼ï¼Œä½¿å¾—æ¯ä¸€å±‚éƒ½èƒ½å­¦ä¹ åˆ°ä¸åŒå±‚æ¬¡çš„ç‰¹å¾ã€‚

æ€»ç»“ï¼š
è™½ç„¶è·³è·ƒè¿æ¥é€šè¿‡ç›´æ¥ä¼ é€’è¾“å…¥æ¥åŠ é€Ÿè®­ç»ƒï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ä¸­é—´å±‚è¢«å¿½ç•¥äº†ã€‚äº‹å®ä¸Šï¼Œæ®‹å·®å—å†…çš„æ¯ä¸€å±‚ï¼ˆå¦‚å·ç§¯å±‚å’Œæ¿€æ´»å‡½æ•°ï¼‰éƒ½å¯¹ç‰¹å¾å­¦ä¹ èµ·ç€è‡³å…³é‡è¦çš„ä½œç”¨ã€‚
æ®‹å·®å—çš„è®¾è®¡å¹¶æ²¡æœ‰è·³è¿‡è¿™äº›å±‚ï¼Œè€Œæ˜¯è®©ç½‘ç»œå¯ä»¥é€šè¿‡æ®‹å·®å­¦ä¹ çš„æ–¹å¼ï¼Œä½¿å¾—æ¯ä¸€å±‚çš„è¾“å‡ºèƒ½å¤Ÿæœ‰æ•ˆåœ°ä¸è¾“å…¥ä¿¡æ¯ç»“åˆï¼Œä»è€ŒåŠ å¿«ç½‘ç»œçš„æ”¶æ•›å¹¶æå‡æ€§èƒ½ã€‚

ä¸ºä»€ä¹ˆé€šè¿‡æŠŠç½‘ç»œæœ‰å­¦ä¹ ç›®æ ‡å˜æˆå­¦ä¹ è¾“å‡ºä¸è¾“å…¥ä¹‹é—´çš„å·®å€¼ï¼Œå†åŠ ä¸Šè¾“å‡ºä¸­åŠ å…¥åŸå§‹æ•°æ®ï¼Œå°±å¯ä»¥ç¼“è§£é‚£äº›é—®é¢˜ï¼Ÿ
åœ¨è®­ç»ƒæ·±å±‚ç¥ç»ç½‘ç»œæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé‡åˆ°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

a. æ¢¯åº¦æ¶ˆå¤±/æ¢¯åº¦çˆ†ç‚¸
éšç€ç½‘ç»œå±‚æ•°å¢åŠ ï¼Œåå‘ä¼ æ’­æ—¶ï¼Œæ¢¯åº¦çš„ä¼ æ’­å¯èƒ½ä¼šå˜å¾—éå¸¸å°ï¼ˆæ¢¯åº¦æ¶ˆå¤±ï¼‰æˆ–è€…éå¸¸å¤§ï¼ˆæ¢¯åº¦çˆ†ç‚¸ï¼‰ï¼Œä½¿å¾—è®­ç»ƒå˜å¾—å›°éš¾ã€‚å°¤å…¶æ˜¯åœ¨æ·±å±‚ç½‘ç»œä¸­ï¼Œè¯¯å·®æ¢¯åº¦åœ¨æ¯ä¸€å±‚éƒ½ä¼šè¢«åå‘ä¼ æ’­ï¼Œè€Œæ¢¯åº¦åœ¨ä¼ é€’è¿‡ç¨‹ä¸­é€æ¸ç¼©å°æˆ–è€…æ”¾å¤§ï¼Œå¯¼è‡´ä¼˜åŒ–æ— æ³•æœ‰æ•ˆè¿›è¡Œã€‚

b. å­¦ä¹ ç›®æ ‡å˜å¾—å¤æ‚
åœ¨ä¼ ç»Ÿçš„ç¥ç»ç½‘ç»œä¸­ï¼Œæ¨¡å‹è¦ç›´æ¥å­¦ä¹ ä»è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„ã€‚å¦‚æœç½‘ç»œè¶³å¤Ÿæ·±ï¼Œå­¦ä¹ çš„ç›®æ ‡å˜å¾—éå¸¸å¤æ‚ï¼Œä¸”å®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜ï¼Œæ— æ³•æœ‰æ•ˆåœ°è®­ç»ƒç½‘ç»œã€‚

c. è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸ç¨³å®šæ€§
éšç€å±‚æ•°çš„å¢åŠ ï¼Œç½‘ç»œå¯èƒ½ä¼šå˜å¾—éå¸¸éš¾ä»¥è®­ç»ƒï¼Œå°¤å…¶æ˜¯åœ¨ä¸è‰¯åˆå§‹åŒ–æˆ–é€‰æ‹©ä¸åˆé€‚çš„æ¿€æ´»å‡½æ•°çš„æƒ…å†µä¸‹ã€‚ç½‘ç»œçš„è®­ç»ƒå¯èƒ½éå¸¸æ…¢ï¼Œç”šè‡³å‡ºç°æ”¶æ•›æ€§é—®é¢˜ã€‚

ä¸ºä»€ä¹ˆæ®‹å·®ï¼ˆå·®å€¼ï¼‰å­¦ä¹ æœ‰æ•ˆï¼Ÿ
a. ç®€åŒ–å­¦ä¹ ç›®æ ‡
åœ¨ä¼ ç»Ÿç¥ç»ç½‘ç»œä¸­ï¼Œæˆ‘ä»¬è¦æ±‚ç½‘ç»œ å­¦ä¹ ä»è¾“å…¥åˆ°è¾“å‡ºçš„ç›´æ¥æ˜ å°„ã€‚éšç€ç½‘ç»œå±‚æ•°çš„å¢åŠ ï¼Œè¿™ä¸ªæ˜ å°„å˜å¾—éå¸¸å¤æ‚ã€‚

è€Œåœ¨ æ®‹å·®ç½‘ç»œ (ResNet) ä¸­ï¼Œç½‘ç»œçš„ç›®æ ‡ä»å­¦ä¹ è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„ï¼Œè½¬å˜ä¸ºå­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„ å·®å€¼ï¼ˆå³æ®‹å·®ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¦æ±‚ç½‘ç»œå­¦ä¹ çš„ç›®æ ‡å˜å¾—æ›´åŠ ç®€å•å’Œæ˜ç¡®ã€‚

ä¸ºä»€ä¹ˆæ®‹å·®å­¦ä¹ æ›´ç®€å•ï¼Ÿ
a. ç®€åŒ–å­¦ä¹ ç›®æ ‡
å‡è®¾ä½ çš„ç›®æ ‡å‡½æ•°æ˜¯ä»è¾“å…¥ æ˜ å°„åˆ°è¾“å‡º å³ y=f(x)ã€‚
å¦‚æœç½‘ç»œå¾ˆæ·±ï¼Œå­¦ä¹ è¿™æ ·çš„æ˜ å°„å¯èƒ½éå¸¸å›°éš¾ã€‚ç›¸åï¼Œç½‘ç»œåªéœ€è¦å­¦ä¹ å¦‚ä½•å°†è¾“å…¥ä¸ç›®æ ‡è¾“å‡ºä¹‹é—´çš„å·®å¼‚ï¼ˆæ®‹å·®ï¼‰åŠ èµ·æ¥ï¼š
è¿™æ ·ï¼Œç½‘ç»œåªéœ€è¦å­¦ä¹ â€œå·®è·â€ï¼Œè€Œä¸æ˜¯å®Œå…¨ä»è¾“å…¥åˆ°è¾“å‡ºçš„æ˜ å°„ã€‚è¿™è®©ç½‘ç»œå˜å¾—æ›´å®¹æ˜“è®­ç»ƒï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯åœ¨ å­¦ä¹ å¾®å°çš„è°ƒæ•´ï¼Œè€Œä¸æ˜¯é‡æ–°å­¦ä¹ ä»å¤´å¼€å§‹çš„å…¨å±€æ˜ å°„ã€‚
b. é¿å…æ¢¯åº¦æ¶ˆå¤±å’Œæ¢¯åº¦çˆ†ç‚¸
æ®‹å·®å—é€šè¿‡ è·³è·ƒè¿æ¥ï¼Œä½¿å¾—è¾“å…¥ 
ğ‘¥ç›´æ¥ä¼ é€’åˆ°æ›´æ·±çš„å±‚ï¼Œå¹¶ä¸ç½‘ç»œçš„è¾“å‡ºç›¸åŠ ã€‚è¿™ç§ç»“æ„æœ‰å‡ ä¸ªå¥½å¤„ï¼š
æ¢¯åº¦æ›´å®¹æ˜“ä¼ æ’­ï¼šåœ¨åå‘ä¼ æ’­æ—¶ï¼Œè·³è·ƒè¿æ¥ä¸ºæ¢¯åº¦æä¾›äº†ç›´æ¥è·¯å¾„ï¼Œé¿å…äº†æ¢¯åº¦é€æ¸æ¶ˆå¤±ã€‚å³ä½¿ç½‘ç»œéå¸¸æ·±ï¼Œæ¢¯åº¦ä»ç„¶èƒ½å¤Ÿæœ‰æ•ˆä¼ æ’­åˆ°ç½‘ç»œçš„è¾ƒæµ…å±‚ï¼Œä¿æŒäº†æ¢¯åº¦çš„ ç¨³å®šæ€§ã€‚å› æ­¤ï¼Œç½‘ç»œçš„è®­ç»ƒå˜å¾—æ›´åŠ ç¨³å®šï¼Œé¿å…äº†æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸çš„é—®é¢˜ã€‚
æ›´å¥½çš„æ¢¯åº¦æµåŠ¨ï¼šé€šè¿‡è·³è·ƒè¿æ¥ï¼Œæ®‹å·®ç½‘ç»œå…è®¸æ¢¯åº¦ç›´æ¥æµå‘å‰é¢çš„å±‚ï¼Œå¹¶ä¸”ç”±äºç½‘ç»œå­¦ä¹ çš„æ˜¯å·®å¼‚ï¼ˆæ®‹å·®ï¼‰ï¼Œæ¢¯åº¦å¯ä»¥åœ¨ç½‘ç»œä¸­æµåŠ¨å¾—æ›´åŠ é«˜æ•ˆã€‚è¿™æ ·ï¼Œæ¢¯åº¦å¯ä»¥å¿«é€Ÿä¼ é€’ç»™è¾ƒæµ…å±‚çš„ç½‘ç»œï¼Œå¸®åŠ©å®ƒä»¬æœ‰æ•ˆåœ°æ›´æ–°æƒé‡ã€‚
c. åŠ é€Ÿè®­ç»ƒè¿‡ç¨‹
ç”±äºç½‘ç»œçš„å­¦ä¹ ç›®æ ‡å˜å¾—æ›´åŠ ç®€åŒ–ï¼Œç½‘ç»œä¸å†éœ€è¦å­¦ä¹ éå¸¸å¤æ‚çš„æ˜ å°„ã€‚æ®‹å·®å— é™ä½äº†è®­ç»ƒçš„éš¾åº¦ï¼Œä½¿å¾—è®­ç»ƒæ›´å®¹æ˜“ä¸”æ›´å¿«ã€‚
å¦å¤–ï¼Œæ®‹å·®å—è¿˜ å‡å°‘äº†ä¿¡æ¯çš„æŸå¤±ã€‚åœ¨ä¼ ç»Ÿçš„ç½‘ç»œä¸­ï¼Œè¾“å…¥ä¿¡æ¯ä¼šè¢«æ¯ä¸€å±‚é€æ¸å˜æ¢å’Œå‹ç¼©ï¼Œå¯èƒ½ä¼šä¸¢å¤±ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚è€Œæ®‹å·®å—é€šè¿‡è·³è·ƒè¿æ¥è®©è¾“å…¥ä¿¡æ¯èƒ½å¤Ÿä¸è¾“å‡ºç»“åˆï¼Œä»è€Œæœ‰æ•ˆä¿ç•™è¾“å…¥çš„ å…³é”®ä¿¡æ¯ï¼Œé¿å…è¿‡å¤šçš„ä¿¡æ¯ä¸¢å¤±ã€‚

ä¸ºä»€ä¹ˆåŠ ä¸Šè¾“å…¥ä¿¡æ¯ï¼ˆè·³è·ƒè¿æ¥ï¼‰å¯ä»¥ç¼“è§£è¿™äº›é—®é¢˜ï¼Ÿ
a. ä¿¡æ¯ä¿ç•™
é€šè¿‡ç›´æ¥å°†è¾“å…¥ æ·»åŠ åˆ°è¾“å‡º F(x) ä¸­ï¼ˆå³è¿›è¡ŒåŠ æ³•æ“ä½œï¼‰ï¼Œæˆ‘ä»¬ä¿ç•™äº†è¾“å…¥çš„åŸå§‹ä¿¡æ¯ï¼Œå¹¶ä¸”å®ƒä¸ç½‘ç»œå­¦ä¹ åˆ°çš„ç‰¹å¾ç›¸ç»“åˆï¼Œå½¢æˆäº†æœ€ç»ˆçš„è¾“å‡ºã€‚
è¿™ç§æ–¹å¼æœ‰åŠ©äºç½‘ç»œæ›´å¥½åœ°ä¿ç•™è¾“å…¥çš„åŸå§‹ç‰¹å¾ï¼Œé¿å…åœ¨æ·±åº¦ç½‘ç»œä¸­ä¸¢å¤±å…³é”®ä¿¡æ¯ã€‚
b. å¢å¼ºç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›
å³ä½¿ç½‘ç»œéå¸¸æ·±ï¼Œè·³è·ƒè¿æ¥å…è®¸ç½‘ç»œå­¦ä¹ æ®‹å·®è€Œä¸æ˜¯æ•´ä¸ªå‡½æ•°æ˜ å°„ã€‚è¿™æ ·ï¼Œæ¯ä¸€å±‚ç½‘ç»œéƒ½èƒ½åŸºäºå‰é¢çš„ä¿¡æ¯è°ƒæ•´è¾“å‡ºï¼Œè€Œä¸éœ€è¦ä»é›¶å¼€å§‹ã€‚å› æ­¤ï¼Œç½‘ç»œæ›´å®¹æ˜“å­¦åˆ°å¤æ‚çš„ç‰¹å¾ï¼Œå¹¶ä¸”æ›´å®¹æ˜“è¿›è¡Œä¼˜åŒ–ã€‚
c. é¿å…é€€åŒ–é—®é¢˜
åœ¨éå¸¸æ·±çš„ç½‘ç»œä¸­ï¼Œéšç€å±‚æ•°å¢åŠ ï¼Œæ¨¡å‹çš„è¡¨ç°å¯èƒ½ä¼šä¸‹é™ï¼Œè¿™è¢«ç§°ä¸º é€€åŒ–é—®é¢˜ã€‚æ®‹å·®ç½‘ç»œé€šè¿‡å¼•å…¥è·³è·ƒè¿æ¥ï¼Œå®é™…ä¸Šåœ¨æŸç§ç¨‹åº¦ä¸Šé¿å…äº†è¿™ä¸€é—®é¢˜ã€‚ç”±äºæ¯ä¸ªæ®‹å·®å—éƒ½å¯ä»¥å­¦ä¹ åˆ°ä¸€å°æ­¥çš„æ˜ å°„ï¼Œå³ä½¿ç½‘ç»œå±‚æ•°å¢åŠ ï¼Œæ¨¡å‹çš„æ€§èƒ½ä¹Ÿä¸ä¼šé€€åŒ–ã€‚

è·³è·ƒè¿æ¥ï¼šè·³è·ƒè¿æ¥çš„æ„æ€æ˜¯ï¼Œåœ¨ä¸€ä¸ªæ®‹å·®å—çš„å†…éƒ¨ï¼Œè¾“å…¥å’Œç»è¿‡æ®‹å·®å—å·ç§¯å±‚å¤„ç†åçš„è¾“å‡ºè¿æ¥ï¼Œè€Œä¸æ˜¯æ®‹å·®å—å’Œæ®‹å·®å—çš„è¿æ¥ã€‚


å¸¸è§çš„æ®‹å·®å—ç»“æ„
é€šå¸¸ï¼Œä¸€ä¸ªæ ‡å‡†çš„æ®‹å·®å—åŒ…æ‹¬ï¼š
ç¬¬ä¸€ä¸ªå·ç§¯å±‚ï¼šé€šå¸¸æ˜¯ä¸€ä¸ª 
1.3Ã—3 çš„å·ç§¯æ ¸ï¼Œæ­¥é•¿é€šå¸¸ä¸º 1ï¼Œå¡«å……ï¼ˆpaddingï¼‰ä¸º 1ï¼Œè¿™æ ·ä¿æŒè¾“å…¥è¾“å‡ºçš„å¤§å°ä¸€è‡´ã€‚
ReLUæ¿€æ´»å‡½æ•°ï¼šå¯¹å·ç§¯ç»“æœåº”ç”¨ ReLU æ¿€æ´»å‡½æ•°ã€‚
2.ç¬¬äºŒä¸ªå·ç§¯å±‚ï¼šä¸ç¬¬ä¸€ä¸ªå·ç§¯å±‚ç›¸ä¼¼ï¼Œé€šå¸¸ä¹Ÿæ˜¯ 3Ã—3 çš„å·ç§¯æ ¸ï¼Œæ­¥é•¿ä¸º 1ï¼Œå¡«å……ä¸º 1ã€‚
3.è·³è·ƒè¿æ¥ï¼šè¾“å…¥ä¿¡å·ï¼ˆæˆ–è€…æŸäº›æƒ…å†µä¸‹ç»è¿‡1x1å·ç§¯è°ƒæ•´åçš„ä¿¡å·ï¼‰ä¸ç¬¬äºŒä¸ªå·ç§¯å±‚çš„è¾“å‡ºç›¸åŠ ï¼Œå¾—åˆ°æ®‹å·®å—çš„æœ€ç»ˆè¾“å‡ºã€‚
æ€»ç»“èµ·æ¥ï¼Œä¸€ä¸ªå…¸å‹çš„æ®‹å·®å—æœ‰ ä¸¤ä¸ªå·ç§¯å±‚ã€‚ä½†æ˜¯æœ‰äº›æ›´å¤æ‚çš„æ®‹å·®å—å¯ä»¥åŒ…å«æ›´å¤šçš„å·ç§¯å±‚ã€æ‰¹å½’ä¸€åŒ–ï¼ˆBatchNormï¼‰ã€ä¸åŒå°ºå¯¸çš„å·ç§¯æ ¸ã€ç”šè‡³åŒ…å«ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚

'''
class ResidualBlock(nn.Module):
    def __init__(self, in_channels, out_channels, kernel_size=3, stride=1, padding=1):
        super(ResidualBlock, self).__init__()

        # ç¬¬ä¸€å±‚å·ç§¯ + æ‰¹å½’ä¸€åŒ– + æ¿€æ´»
        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size, stride, padding)
        self.bn1 = nn.BatchNorm2d(out_channels)
        self.relu = nn.ReLU(inplace=True)

        # ç¬¬äºŒå±‚å·ç§¯ + æ‰¹å½’ä¸€åŒ–
        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size, stride, padding)
        self.bn2 = nn.BatchNorm2d(out_channels)

        #nn.Sequential() æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºæŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ªå±‚
        #è¿™é‡Œæ˜¯ä¸ºäº†äº†ç»™æ®‹å·®è¿æ¥æä¾›ä¸€ä¸ªå ä½ç¬¦ã€‚ä½†å¦‚æœå®ƒæ²¡æœ‰ä¼ å…¥ä»»ä½•å±‚ï¼Œé‚£ä¹ˆå®ƒå°±è¡¨ç¤ºä¸€ä¸ªç©ºçš„æ“ä½œï¼Œæ„å‘³ç€è¯¥éƒ¨åˆ†ä¸ä¼šå¯¹è¾“å…¥è¿›è¡Œä»»ä½•å˜æ¢ã€‚
        #è€Œå¦‚æœè¾“å…¥å›¾çš„é€šé“å’Œæ®‹å·®å—çš„è¾“å‡ºé€šé“ä¸åŒ¹é…ï¼Œå°±éœ€è¦ä¸‹é¢çš„å·ç§¯å±‚è¿›è¡Œå¤„ç†
        self.shortcut = nn.Sequential()
        # æ®‹å·®è¿æ¥ï¼šè¾“å…¥å’Œè¾“å‡ºçš„é€šé“æ•°ä¸åŒ¹é…æ—¶ï¼Œä½¿ç”¨1x1å·ç§¯ï¼Œin_channelsï¼šè¾“å…¥é€šé“æ•°ï¼Œout_channelsï¼šè¾“å‡ºé€šé“æ•°
        # 1x1 å·ç§¯ çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡è°ƒæ•´é€šé“æ•°æ¥æ”¹å˜ç‰¹å¾å›¾çš„æ·±åº¦ï¼Œè€Œä¸æ”¹å˜å›¾åƒçš„ç©ºé—´å°ºå¯¸ï¼Œå·ç§¯æ ¸çš„å°ºå¯¸æ˜¯ 1x1ï¼Œå®ƒåªè¦†ç›–è¾“å…¥çš„æ¯ä¸ªåƒç´ ç‚¹ï¼Œä¸è¿›è¡Œç©ºé—´ä¸Šçš„æ‰©å±•ã€‚
        # ç”±äºåœ¨å®šä¹‰1x1å·ç§¯å±‚æ—¶ï¼Œè®¾å®šäº†out_channelsã€‚è¿™æ„å‘³ç€æ¯ä¸ªè¾“å…¥åƒç´ ç‚¹ï¼ˆæ¯ä¸ªä½ç½®çš„æ‰€æœ‰é€šé“ç‰¹å¾ï¼‰éƒ½ä¼šé€šè¿‡out_channelsä¸ªä¸åŒçš„å·ç§¯æ ¸è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œæœ€ç»ˆç”Ÿæˆ128ä¸ªè¾“å‡ºé€šé“
        # æ‰€ä»¥æœ€ç»ˆï¼Œå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ä¿æŒä¸å˜ï¼Œè€Œé€šé“æ•°æ”¹å˜
        if in_channels != out_channels:
            self.shortcut = nn.Conv2d(in_channels, out_channels, kernel_size=1, stride=1, padding=0)

    def forward(self, x):
        # å·ç§¯å±‚1 -> æ¿€æ´»å‡½æ•° -> æ‰¹å½’ä¸€åŒ–
        out = self.relu(self.bn1(self.conv1(x)))

        # å·ç§¯å±‚2 -> æ‰¹å½’ä¸€åŒ–
        out = self.bn2(self.conv2(out))

        # åŠ ä¸Šæ®‹å·®è¿æ¥
        out += self.shortcut(x)

        # æœ€åé€šè¿‡ReLUæ¿€æ´»å‡½æ•°
        out = self.relu(out)

        return out


# Generator with residual blocks
class Generator(nn.Module):
    def __init__(self):
        super(Generator, self).__init__()

        # é€€åŒ–å›¾åƒå¤„ç†åˆ†æ”¯
        self.degraded_image_branch = nn.Sequential(
            nn.Conv2d(1, 64, kernel_size=3, stride=2, padding=1),
            nn.ReLU(),
            nn.BatchNorm2d(64),
            nn.MaxPool2d(kernel_size=2),
            ResidualBlock(64, 128),
            ResidualBlock(128, 256),
            ResidualBlock(256, 512),
        )

        # PSFå¤„ç†åˆ†æ”¯ï¼ˆç›¸å·®ç‰¹å¾å¤„ç†ï¼‰
        self.psf_branch = nn.Sequential(
            nn.Conv1d(256 * 19, 512, kernel_size=3, stride=1, padding=1),
            nn.ReLU(),
            nn.BatchNorm1d(512),
            ResidualBlock(512, 256),  # ä½¿ç”¨æ®‹å·®å—å¤„ç†PSFç‰¹å¾
            nn.ReLU(),
        )

        # èåˆ
        self.flatten = nn.Flatten()
        self.fc1 = nn.Linear(512 * 44 * 44 + 256, 1024)

        # å›¾åƒæ¢å¤åˆ†æ”¯
        self.deconv1 = nn.ConvTranspose2d(512, 256, kernel_size=3, stride=2, padding=1)
        self.deconv2 = nn.ConvTranspose2d(256, 128, kernel_size=3, stride=2, padding=1)
        self.deconv3 = nn.ConvTranspose2d(128, 64, kernel_size=3, stride=2, padding=1)
        self.deconv4 = nn.ConvTranspose2d(64, 1, kernel_size=3, stride=2, padding=1)

    def forward(self, degraded_image, psf_matrix):
        x = self.degraded_image_branch(degraded_image)
        x = self.flatten(x)

        psf_features = self.psf_branch(psf_matrix)
        combined = torch.cat([x, psf_features], dim=1)

        x = self.fc1(combined)
        x = x.view(-1, 512, 1, 1)

        x = self.deconv1(x)
        x = self.deconv2(x)
        x = self.deconv3(x)
        output_image = self.deconv4(x)

        return output_image
# Discriminator with residual blocks
class Discriminator(nn.Module):
    def __init__(self):
        super(Discriminator, self).__init__()

        # é€€åŒ–å›¾åƒå¤„ç†åˆ†æ”¯
        self.degraded_image_branch = nn.Sequential(
            nn.Conv2d(1, 64, kernel_size=3, stride=2, padding=1),
            nn.LeakyReLU(0.2),
            nn.BatchNorm2d(64),
            ResidualBlock(64, 128),
            ResidualBlock(128, 256),
            ResidualBlock(256, 512),
        )

        # èåˆé€€åŒ–å›¾åƒç‰¹å¾
        self.flatten = nn.Flatten()
        self.fc1 = nn.Linear(512 * 44 * 44, 1024)  # æ‰å¹³åŒ–åçš„ç‰¹å¾è¾“å…¥å…¨è¿æ¥å±‚
        self.fc2 = nn.Linear(1024, 1)  # è¾“å‡ºçœŸå‡åˆ¤æ–­ï¼ˆ0 æˆ– 1ï¼‰

    def forward(self, degraded_image):
        # é€€åŒ–å›¾åƒåˆ†æ”¯
        x = self.degraded_image_branch(degraded_image)
        x = self.flatten(x)  # å±•å¹³ç‰¹å¾

        # åˆ¤åˆ«å™¨æœ€ç»ˆåˆ¤æ–­
        x = self.fc1(x)
        x = torch.leaky_relu(x, negative_slope=0.2)
        output = self.fc2(x)  # è¾“å‡ºçœŸå‡åˆ¤æ–­ï¼ˆ0 æˆ– 1ï¼‰

        return output


